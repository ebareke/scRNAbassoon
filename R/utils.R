#' Custom Theme for scRNAbassoon Plots
#' 
#' Internal theme function that creates a consistent, publication-ready
#' appearance for all plots generated by scRNAbassoon.
#' 
#' @param base_size Numeric. Base font size for all text elements. Default: 14
#' 
#' @return A ggplot2 theme object that can be added to plots
#' 
#' @details
#' This theme extends \code{theme_bw} with bold text elements and optimized
#' spacing for single-cell visualizations. It ensures:
#' \itemize{
#'   \item Bold, readable axis labels and titles
#'   \item Right-positioned legend for easier interpretation
#'   \item Consistent sizing across all plot types
#'   \item Professional appearance suitable for publication
#' }
#' 
#' @keywords internal
#' @importFrom ggplot2 theme_bw theme element_text
.theme_bw_custom <- function(base_size = 14) {
  theme_bw(base_size = base_size) +
    theme(
      legend.position = "right",
      legend.title = element_text(size = base_size, face = "bold"),
      legend.text = element_text(size = base_size * 0.9, face = "bold"),
      plot.title = element_text(size = base_size * 1.1, face = "bold"),
      axis.text = element_text(size = base_size * 0.9, face = "bold"),
      axis.title = element_text(size = base_size, face = "bold")
    )
}

#' Safe Plot Saving with Multiple Format Support
#' 
#' Internal helper function that safely saves ggplot objects to disk with
#' comprehensive error handling and support for multiple output formats.
#' 
#' @param plot_obj A ggplot2 plot object to save
#' @param filename Character. Base filename without extension (e.g., "UMAP_plot")
#' @param out_dir Character. Output directory path where file will be saved
#' @param width Numeric. Plot width in inches
#' @param height Numeric. Plot height in inches
#' @param format Character. Output format: "pdf", "png", or "both". Default: "pdf"
#' 
#' @return NULL (invisible). Saves plot files as side effect.
#' 
#' @details
#' This function:
#' \itemize{
#'   \item Automatically strips existing extensions from filename
#'   \item Saves PDF with vector graphics (publication quality)
#'   \item Saves PNG at 300 dpi for presentations
#'   \item Wraps saves in tryCatch for graceful error handling
#'   \item Reports errors without stopping pipeline execution
#' }
#' 
#' PDF format is recommended for publications due to scalability. PNG format
#' is useful for presentations, web display, or when file size matters.
#' 
#' @keywords internal
#' @importFrom ggplot2 ggsave
.save_plot <- function(plot_obj, filename, out_dir, width, height, format = "pdf") {
  base_name <- tools::file_path_sans_ext(filename)
  
  if (format %in% c("pdf", "both")) {
    path_pdf <- file.path(out_dir, paste0(base_name, ".pdf"))
    tryCatch({
      ggsave(path_pdf, plot = plot_obj, width = width, height = height, device = "pdf")
    }, error = function(e) message("PDF save failed: ", e$message))
  }
  
  if (format %in% c("png", "both")) {
    path_png <- file.path(out_dir, paste0(base_name, ".png"))
    tryCatch({
      ggsave(path_png, plot = plot_obj, width = width, height = height, dpi = 300, device = "png")
    }, error = function(e) message("PNG save failed: ", e$message))
  }
}

#' Auto-Calculate Plot Dimensions
#' 
#' Internal function that dynamically calculates appropriate plot dimensions
#' based on the number of items to display, preventing overcrowding or
#' excessive whitespace.
#' 
#' @param n_items Integer. Number of items to display (e.g., samples, cell types)
#' @param base_w Numeric. Base width in inches before scaling
#' @param base_h Numeric. Base height in inches before scaling
#' @param orientation Character. Plot orientation: "horizontal" or "vertical".
#'   Default: "horizontal"
#' 
#' @return Named list with two components:
#' \describe{
#'   \item{width}{Calculated width in inches (capped at 40)}
#'   \item{height}{Calculated height in inches (capped at 30)}
#' }
#' 
#' @details
#' Scaling rules:
#' \itemize{
#'   \item \strong{Horizontal}: Adds 0.5 inches per item to width
#'   \item \strong{Vertical}: Adds 0.3 inches per item to height
#'   \item Maximum dimensions: 40 × 30 inches (prevents unwieldy files)
#' }
#' 
#' This ensures plots remain readable regardless of the number of facets,
#' replicates, or cell types being displayed.
#' 
#' @examples
#' \dontrun{
#' # Calculate dimensions for 6 samples in horizontal layout
#' dims <- .auto_dims(n_items = 6, base_w = 12, base_h = 8, orientation = "horizontal")
#' # Returns: list(width = 15, height = 8)
#' 
#' # For vertical stacking
#' dims <- .auto_dims(n_items = 10, base_w = 10, base_h = 6, orientation = "vertical")
#' # Returns: list(width = 10, height = 9)
#' }
#' 
#' @keywords internal
.auto_dims <- function(n_items, base_w, base_h, orientation = "horizontal") {
  if (orientation == "horizontal") {
    w <- base_w + (n_items * 0.5)
    h <- base_h
  } else {
    w <- base_w
    h <- base_h + (n_items * 0.3)
  }
  list(width = min(w, 40), height = min(h, 30))
}

#' Setup Output Directory Structure
#' 
#' Creates a standardized, organized directory structure for storing all
#' scRNAbassoon pipeline outputs including QC plots, differential expression
#' results, enrichment analyses, and trajectory outputs.
#' 
#' @param base_dir Character. Base output directory path. All subdirectories
#'   will be created within this location.
#' 
#' @return Named list of directory paths with the following components:
#' \describe{
#'   \item{qc}{Quality control plots (violin plots, scatter plots)}
#'   \item{replicates}{Per-replicate visualizations and analyses}
#'   \item{samples}{Per-sample (experimental group) visualizations}
#'   \item{global}{Global analysis results including complete Seurat object,
#'     global UMAPs, and cluster visualizations}
#'   \item{de}{Differential expression results organized by comparison and cell type}
#'   \item{trajectory}{Pseudotime trajectory analysis results (Slingshot)}
#'   \item{enrichment}{Pathway enrichment results (ORA and GSEA) organized by
#'     comparison and cell type}
#'   \item{markers}{Marker gene discovery results including CSV tables and heatmaps}
#' }
#' 
#' @details
#' This function creates a complete directory structure following best practices
#' for computational biology projects:
#' 
#' \preformatted{
#' base_dir/
#' ├── QC/                    # Quality control metrics
#' ├── Global/                # Dataset-wide analyses
#' ├── Replicates/            # Individual replicate results
#' ├── Samples/               # Results grouped by condition
#' ├── Markers/               # Cluster marker genes
#' ├── DE/                    # Differential expression
#' │   └── GroupA_vs_GroupB/
#' │       ├── CellType1/
#' │       └── CellType2/
#' ├── Enrichment/            # Pathway enrichment
#' │   └── GroupA_vs_GroupB/
#' │       ├── CellType1/
#' │       │   ├── ORA/
#' │       │   └── GSEA/
#' │       └── CellType2/
#' └── Trajectory/            # Pseudotime analyses
#' }
#' 
#' All directories are created recursively with \code{recursive = TRUE}, so
#' intermediate directories are automatically created if they don't exist.
#' 
#' This function is called automatically by \code{\link{run_bassoon_pipeline}}
#' but can also be used standalone for custom workflows or manual directory
#' setup before running individual analysis modules.
#' 
#' @section File Organization:
#' The directory structure separates concerns:
#' \itemize{
#'   \item \strong{QC}: Initial data quality assessment
#'   \item \strong{Global}: Complete dataset overview
#'   \item \strong{Replicates}: Technical replicate-level detail
#'   \item \strong{Samples}: Biological condition comparisons
#'   \item \strong{Markers}: Cell type identification
#'   \item \strong{DE}: Statistical comparisons between conditions
#'   \item \strong{Enrichment}: Biological interpretation of DE results
#'   \item \strong{Trajectory}: Temporal/developmental dynamics
#' }
#' 
#' @examples
#' \dontrun{
#' # Create standard directory structure
#' dirs <- setup_output_dirs("/path/to/project/results/")
#' 
#' # Access specific directories
#' qc_dir <- dirs$qc
#' de_dir <- dirs$de
#' 
#' # Use in custom workflow
#' dirs <- setup_output_dirs("./my_analysis/")
#' seu <- load_sc_data("data/cellranger/")
#' seu <- run_qc(seu, dirs, 200, 6000, 15, "pdf", 14, 12)
#' # ... continue analysis
#' 
#' # Directory structure is now:
#' # ./my_analysis/
#' #   ├── QC/
#' #   ├── Global/
#' #   └── ... (all other directories)
#' }
#' 
#' @seealso 
#' \code{\link{run_bassoon_pipeline}} for the main pipeline that uses this function
#' 
#' @export
setup_output_dirs <- function(base_dir) {
  dirs <- list(
    qc = file.path(base_dir, "QC"),
    replicates = file.path(base_dir, "Replicates"),
    samples = file.path(base_dir, "Samples"),
    global = file.path(base_dir, "Global"),
    de = file.path(base_dir, "DE"),
    trajectory = file.path(base_dir, "Trajectory"),
    enrichment = file.path(base_dir, "Enrichment"),
    markers = file.path(base_dir, "Markers")
  )
  lapply(dirs, function(d) dir.create(d, showWarnings = FALSE, recursive = TRUE))
  return(dirs)
}

#' Create ZIP Bundle of Analysis Results
#' 
#' Internal function that compresses all analysis outputs into a single ZIP
#' archive for easy sharing, archiving, or transfer.
#' 
#' @param out_dir Character. Output directory containing analysis results to compress
#' 
#' @return NULL (invisible). Creates ZIP file as side effect.
#' 
#' @details
#' This function:
#' \itemize{
#'   \item Recursively collects all files from the output directory
#'   \item Creates a ZIP archive named "Complete_Analysis.zip"
#'   \item Places the ZIP file in the root of the output directory
#'   \item Overwrites existing ZIP if present
#'   \item Handles errors gracefully without stopping the pipeline
#' }
#' 
#' The resulting ZIP archive contains the complete directory structure with
#' all plots, tables, and R objects, making it ideal for:
#' \itemize{
#'   \item Sharing results with collaborators
#'   \item Long-term archiving of complete analyses
#'   \item Transferring to computing clusters or cloud storage
#'   \item Creating analysis snapshots at different time points
#' }
#' 
#' @section File Size:
#' The ZIP file size depends on:
#' \itemize{
#'   \item Number of plots generated
#'   \item Plot format (PDF vs PNG vs both)
#'   \item Size of Seurat object (cell count)
#'   \item Number of DE comparisons
#' }
#' 
#' Typical sizes range from 50 MB to several GB for large datasets.
#' 
#' @examples
#' \dontrun{
#' # Typically called automatically by run_bassoon_pipeline
#' # when zip_outputs = TRUE
#' 
#' # Can also be called manually after analysis
#' .create_zip_bundle("/path/to/results/")
#' # Creates: /path/to/results/Complete_Analysis.zip
#' }
#' 
#' @keywords internal
#' @importFrom zip zipr
.create_zip_bundle <- function(out_dir) {
  message("Creating ZIP bundle...")
  files <- list.files(out_dir, full.names = TRUE, recursive = TRUE)
  zip_path <- file.path(out_dir, "Complete_Analysis.zip")
  if (file.exists(zip_path)) unlink(zip_path)
  tryCatch({
    zip::zipr(zipfile = zip_path, files = files)
    message(sprintf("ZIP bundle created: %s", zip_path))
  }, error = function(e) message("ZIP creation failed: ", e$message))
}
